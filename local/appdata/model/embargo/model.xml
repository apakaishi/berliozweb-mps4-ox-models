<?xml version="1.0" encoding="utf-8"?>
<!--
  This document defines the pipelines for the conversion ox model.
-->
<pipelines title="Embargo" icon="file-upload">

    <pipeline id="embargo-single-file"
              name="Upload One Document"
              description="Upload only One Document each time (DOCX, PDF, XLSX, XML, CSV, etc)"
              accepts="*"
              default="true">

        <fields>
            <field type="calendar"
                   id="publish_date"
                   name="publish_date"
                   label="Publish Date"
                   value=""
                   min=""
                   max=""
                   noTitle="false"
                   current="true"
                   prevMonths=""
                   nextMonths=""
                   increment="0"
                   readonly="false"
            />
            <field  type="text"
                    id="title"
                    name="title"
                    label="Document Title"
                    value=""
                    rules="required"
            />
            <field
                    type="select"
                    id="description"
                    name="description"
                    label="Description"
                    active="embargo"
                    values='[
                        {
                          "text":"Embargo", "value":""
                        },
                        {
                          "text": "Offline API", "value": "Offline API"
                        },
                        {
                          "text":"SQLite", "value":"SQLite"
                        },

                        {
                          "text":"Chemotherapy", "value":"Chemotherapy"
                        }
                      ]'
                    rules="required"
            />
        </fields>

        <step id="copy-input-file" name="Copy Input File" viewable="false" class="net.pageseeder.ox.web.step.CopyInputToFolder">
            <parameter name="output"                value="final/binary/"/>
            <parameter name="month"                 value="{publish_date_month}"/>
            <parameter name="year"                  value="{publish_date_year}"/>
        </step>
        <step id="copy-document-xml" name="Copying document.xml" class="org.pageseeder.ox.step.Copy">
            <parameter name="input"                 value="resources" />
            <parameter name="output"                value="files/resources"/>
        </step>
        <step id="create-metadata-document" name="Create Metadata PSML Document" viewable="false" class="org.pageseeder.ox.step.Transformation">
            <parameter name="input"                 value="files/resources/document.xml" />
            <parameter name="xsl"                   value="xslt/metadata.xsl"/>
            <parameter name="_xslt-metadata-folder" value="final/binary/META-INF/" />
            <parameter name="output"                value="files/step1.psml"/>
        </step>
        <step id="create-embargo-month-psml-document" name="Create Embargo Month PSML Document" viewable="false" class="org.pageseeder.ox.step.Transformation">
            <parameter name="input"                      value="files/resources/document.xml" />
            <parameter name="xsl"                        value="xslt/embargo-month.xsl"/>
            <parameter name="_xslt-embargo-folder"       value="final/psmlsource/" />
            <parameter name="_xslt-type"                 value="simple" />
            <parameter name="output"                     value="files/step2.psml"/>
        </step>
        <step id="create-embargo-reference-psml-document" name="Create Embargo Reference PSML Document" viewable="false" class="org.pageseeder.ox.step.Transformation">
            <parameter name="input"                   value="files/resources/document.xml" />
            <parameter name="xsl"                     value="xslt/generate-embargo-reference.xsl"/>
            <parameter name="_xslt-embargo-folder"    value="final/psmlsource/" />
            <parameter name="_xslt-embargo-path"      value="final/psmlsource/embargo-content-archive.psml" />
            <parameter name="_xslt-type"              value="simple" />
            <parameter name="output"                  value="files/step3.psml"/>
        </step>
        <!-- Populate Embargo data -->
        <!--
        <step id="create-embargo-psml-documents" name="Create Embargo PSML Documents" viewable="false" class="org.pageseeder.ox.step.Transformation">
            <parameter name="input"                 value="files/resources/document.xml" />
            <parameter name="xsl"                   value="xslt/embargo-full-data.xsl"/>
            <parameter name="_xslt-embargo-folder"  value="final/psmlsource/" />
            <parameter name="output"                value="files/step-populate.psml"/>
        </step>-->
        <step id="zip-psml-output" name="Zipping PSML Document." class="org.pageseeder.ox.step.Compression">
            <parameter name="input"                 value="final/binary" />
            <parameter name="output"                value="embargo.zip"/>
        </step>
        <step id="upload-to-pageseeder-loadingzone" name="Upload ZIP to Pageseeder - Binary Document" class="org.pageseeder.ox.pageseeder.step.UploadToLoadingZone"
              async="false" >
            <parameter name="input"                 value="embargo.zip" />
            <parameter name="filename"              value="embargo.zip" />
            <parameter name="autoload"              value="false" />
            <parameter name="psconfig"              value="dev-clone" />
            <parameter name="overwrite"             value="true" />
            <parameter name="group"                 value="data_source-files" />
        </step>
        <step id="unzip-loadingzone-content" name="Unzip File in Pageseeder - Binary Document" class="org.pageseeder.ox.pageseeder.step.UnzipLoadingZoneContent">
            <parameter name="group"                 value="data_source-files" />
            <parameter name="path"                  value="embargo.zip" />
            <parameter name="psconfig"              value="dev-clone" />
            <parameter name="deleteoriginal"        value="true" />
        </step>
        <step id="loads-content-to-the-group" name="Load Unzipped Content to Pageseeder Group  - Binary Document" class="org.pageseeder.ox.pageseeder.step.StartLoading">
            <parameter name="group"                 value="data_source-files" />
            <parameter name="createxrefs"           value="true" />
            <parameter name="index"                 value="true" />
            <parameter name="overwrite"             value="true" />
            <parameter name="psconfig"              value="dev-clone" />
            <parameter name="overwrite-properties"  value="true" />
            <parameter name="validate"              value="true" />
            <parameter name="folder"                value="documents/embargo"/>
        </step>
        <step id="zip-source-documents" name="Zipping Source Documents." class="org.pageseeder.ox.step.Compression">
            <parameter name="input"                 value="final/psmlsource" />
            <parameter name="output"                value="binary.zip"/>
        </step>
        <step id="upload-to-pageseeder-loadingzone-source" name="Upload ZIP to Pageseeder - Source Documents" class="org.pageseeder.ox.pageseeder.step.UploadToLoadingZone"
              async="false" >
            <parameter name="input"                 value="binary.zip" />
            <parameter name="filename"              value="binary.zip" />
            <parameter name="autoload"              value="false" />
            <parameter name="psconfig"              value="dev-clone" />
            <parameter name="overwrite"             value="false" />
            <parameter name="group"                 value="data_source-website" />
        </step>
        <step id="unzip-loadingzone-content-source" name="Unzip File in Pageseeder - Source Documents" class="org.pageseeder.ox.pageseeder.step.UnzipLoadingZoneContent">
            <parameter name="group"                 value="data_source-website" />
            <parameter name="path"                  value="binary.zip" />
            <parameter name="psconfig"              value="dev-clone" />
            <parameter name="deleteoriginal"        value="true" />
        </step>
        <step id="loads-content-to-the-group-source" name="Load Unzipped Content to Pageseeder Group - Source Documents" class="org.pageseeder.ox.pageseeder.step.StartLoading">
            <parameter name="group"                 value="data_source-website" />
            <parameter name="createxrefs"           value="true" />
            <parameter name="index"                 value="true" />
            <parameter name="overwrite"             value="true" />
            <parameter name="psconfig"              value="dev-clone" />
            <parameter name="overwrite-properties"  value="false" />
            <parameter name="validate"              value="true" />
            <parameter name="folder"                value="website/embargo"/>
        </step>
    </pipeline>

    <pipeline id="embargo-multiple-files"
              name="Upload Multiple Files (ZIP)"
              description="Upload Multiple Files at once (ZIP)"
              accepts="application/zip"
              default="true">

        <fields>
            <field type="calendar"
                    id="publish_date"
                    name="publish_date"
                    label="Publish Date"
                    value=""
                    min=""
                    max=""
                    noTitle="false"
                    current="true"
                    prevMonths=""
                    nextMonths=""
                    increment=""
                    readonly="false"
            />
            <field  type="text"
                    id="title"
                    name="title"
                    label="Document Title"
                    value=""
                    rules="required"
            />
            <field
                    type="select"
                    id="description"
                    name="description"
                    label="Description"
                    active="embargo"
                    values='[
                        {
                          "text":"Embargo", "value":""
                        },
                        {
                          "text": "Offline API", "value": "Offline API"
                        },
                        {
                          "text":"SQLite", "value":"SQLite"
                        },

                        {
                          "text":"Chemotherapy", "value":"Chemotherapy"
                        }
                      ]'
                    rules="required"
            />
        </fields>
        <step id="Unzip" name="Unzipping Document." class="net.pageseeder.ox.web.step.UnpackingToFolder">
            <parameter name="output"                value="final/binary/" />
            <parameter name="month"                 value="{publish_date_month}"/>
            <parameter name="year"                  value="{publish_date_year}"/>
        </step>
        <step id="copy-input-file" name="Copy Input File" viewable="false" class="net.pageseeder.ox.web.step.CopyInputToFolder">
            <parameter name="output"                value="final/binary/"/>
            <parameter name="month"                 value="{publish_date_month}"/>
            <parameter name="year"                  value="{publish_date_year}"/>
        </step>
        <step id="list-documents-path" name="Return a XML document with a list of documents" viewable="false" class="org.pageseeder.ox.step.ListFiles" async="true">
            <parameter name="input"                 value="final/binary"/>
            <parameter name="glob-pattern"          value="**/*.*"/>
            <parameter name="output"                value="files/list-files.xml"/>
        </step>
        <step id="create-metadata-documents" name="Create Metadata PSML Documents" viewable="false" class="org.pageseeder.ox.step.Transformation">
            <parameter name="input"                 value="files/list-files.xml" />
            <parameter name="xsl"                   value="xslt/multiple-metadata.xsl"/>
            <parameter name="_xslt-metadata-folder" value="final/binary/META-INF/" />
            <parameter name="output"                value="files/step1.psml"/>
        </step>
        <step id="create-embargo-month-psml-document" name="Create Embargo Month PSML Document" viewable="false" class="org.pageseeder.ox.step.Transformation">
            <parameter name="input"                      value="files/list-files.xml" />
            <parameter name="xsl"                        value="xslt/embargo-month.xsl"/>
            <parameter name="_xslt-embargo-folder"       value="final/psmlsource/" />
            <parameter name="_xslt-type"                 value="multiple" />
            <parameter name="output"                     value="files/step2.psml"/>
        </step>
        <step id="create-embargo-reference-psml-document" name="Create Embargo Reference PSML Document" viewable="false" class="org.pageseeder.ox.step.Transformation">
            <parameter name="input"                   value="files/list-files.xml" />
            <parameter name="xsl"                     value="xslt/generate-embargo-reference.xsl"/>
            <parameter name="_xslt-embargo-folder"    value="final/psmlsource/" />
            <parameter name="_xslt-embargo-path"      value="final/psmlsource/embargo-content-archive.psml" />
            <parameter name="_xslt-type"              value="multiple" />
            <parameter name="output"                  value="files/step3.psml"/>
        </step>
        <step id="zip-psml-output" name="Zipping PSML Document." class="org.pageseeder.ox.step.Compression">
            <parameter name="input"                 value="final/binary" />
            <parameter name="output"                value="embargo.zip"/>
        </step>
        <step id="upload-to-pageseeder-loadingzone" name="Upload ZIP to Pageseeder - Binary Document" class="org.pageseeder.ox.pageseeder.step.UploadToLoadingZone"
              async="false" >
            <parameter name="input"                 value="embargo.zip" />
            <parameter name="filename"              value="embargo.zip" />
            <parameter name="autoload"              value="false" />
            <parameter name="psconfig"              value="dev-clone" />
            <parameter name="overwrite"             value="true" />
            <parameter name="group"                 value="data_source-files" />
        </step>
        <step id="unzip-loadingzone-content" name="Unzip File in Pageseeder - Binary Document" class="org.pageseeder.ox.pageseeder.step.UnzipLoadingZoneContent">
            <parameter name="group"                 value="data_source-files" />
            <parameter name="path"                  value="embargo.zip" />
            <parameter name="psconfig"              value="dev-clone" />
            <parameter name="deleteoriginal"        value="true" />
        </step>
        <step id="loads-content-to-the-group" name="Load Unzipped Content to Pageseeder Group  - Binary Document" class="org.pageseeder.ox.pageseeder.step.StartLoading">
            <parameter name="group"                 value="data_source-files" />
            <parameter name="createxrefs"           value="true" />
            <parameter name="index"                 value="true" />
            <parameter name="overwrite"             value="true" />
            <parameter name="psconfig"              value="dev-clone" />
            <parameter name="overwrite-properties"  value="true" />
            <parameter name="validate"              value="true" />
            <parameter name="folder"                value="documents/embargo"/>
        </step>
        <step id="zip-source-documents" name="Zipping Source Documents." class="org.pageseeder.ox.step.Compression">
            <parameter name="input"                 value="final/psmlsource" />
            <parameter name="output"                value="binary.zip"/>
        </step>
        <step id="upload-to-pageseeder-loadingzone-source" name="Upload ZIP to Pageseeder - Source Documents" class="org.pageseeder.ox.pageseeder.step.UploadToLoadingZone"
              async="false" >
            <parameter name="input"                 value="binary.zip" />
            <parameter name="filename"              value="binary.zip" />
            <parameter name="autoload"              value="false" />
            <parameter name="psconfig"              value="dev-clone" />
            <parameter name="overwrite"             value="false" />
            <parameter name="group"                 value="data_source-website" />
        </step>
        <step id="unzip-loadingzone-content-source" name="Unzip File in Pageseeder - Source Documents" class="org.pageseeder.ox.pageseeder.step.UnzipLoadingZoneContent">
            <parameter name="group"                 value="data_source-website" />
            <parameter name="path"                  value="binary.zip" />
            <parameter name="psconfig"              value="dev-clone" />
            <parameter name="deleteoriginal"        value="true" />
        </step>
        <step id="loads-content-to-the-group-source" name="Load Unzipped Content to Pageseeder Group - Source Documents" class="org.pageseeder.ox.pageseeder.step.StartLoading">
            <parameter name="group"                 value="data_source-website" />
            <parameter name="createxrefs"           value="true" />
            <parameter name="index"                 value="true" />
            <parameter name="overwrite"             value="true" />
            <parameter name="psconfig"              value="dev-clone" />
            <parameter name="overwrite-properties"  value="false" />
            <parameter name="validate"              value="true" />
            <parameter name="folder"                value="website/embargo"/>
        </step>
    </pipeline>

    <pipeline id="mps4-conversion" name="MPS4: Excel to PSML"
              description="MPS4: Excel to PSML"
              accepts="application/vnd.openxmlformats-officedocument.spreadsheetml.sheet"
              default="false">
        <step id="extract-data-from-spreadsheet" name="Extract data from Spreadsheet" viewable="false"
              class="org.pageseeder.xlsx.ox.step.Import">
            <parameter name="split-level"          value="workbook"/>
        </step>
        <step id="converting-metadata" name="Converting Metadata documents" viewable="false"
              class="org.pageseeder.ox.step.Transformation"
              async="true" >
            <parameter name="input"                value="workbook.xml" />
            <parameter name="xsl"    		       value="xslt/metadata-excel.xsl"/>
            <parameter name="output" 			   value="review/data.psml"/>
        </step>
        <!-- Zip output files  -->
        <step id="zip-pbs-files" name="Zipping PBS files"
              class="org.pageseeder.ox.step.Compression"
              async="false" >
            <parameter name="input" value="final" />
            <parameter name="output" value="documents.zip"/>
        </step>
    </pipeline>

</pipelines>



